#!/usr/bin/env python3

import serial
import sys
import time
import os

serial_port = '/dev/ttyUSB0'

dir_name = 'downloads/'

def receive_file(filename):
	ser = serial.Serial(serial_port, 115200, timeout=1)

	ser.write('\n'.encode('utf-8'))
	time.sleep(0.5)
	ser.readline()
	time.sleep(0.5)

	# Send dl command
	fullpath = "/sf/" + filename
	command = f"dl {fullpath}\n"
	print(command)
	ser.write(command.encode('ascii'))

	# Receive file size
	file_size_str = ser.readline().decode('ascii').strip()
	print("filesize", file_size_str)
	file_size = int(file_size_str)

	# Download
	ser.write("\n".encode('ascii'))
	data = ser.read(file_size)

	if not os.path.exists(dir_name):
		os.makedirs(dir_name)

	with open(dir_name + filename, 'wb') as f:
		f.write(data)

	ser.close()

if __name__ == "__main__":
	if len(sys.argv) != 2:
		print("Download a file from the micromouse")
		print("The file will be saved in the ./" + dir_name + " directory.")
		print("Usage: python dl {filename}")
		sys.exit(1)

	filename = sys.argv[1]

	receive_file(filename)
